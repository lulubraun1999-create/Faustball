rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { return request.auth.token.admin == true; }
    
    // --- /users/{userId} ---
    match /users/{userId} {
      function isOwner(userId) { return request.auth.uid == userId; }
      function isCreatingOwnDocument(userId) { return request.auth.uid == userId && request.resource.data.id == userId && (request.resource.data.role == 'user' || !('role' in request.resource.data)); }
      function isUpdatingOwnDocument(userId) { return isOwner(userId) && !('role' in request.resource.data); }
      
      allow get: if isSignedIn() && (isOwner(userId) || isAdmin());
      allow list: if isSignedIn() && isAdmin();
      allow create: if isSignedIn() && isCreatingOwnDocument(userId);
      allow update: if isSignedIn() && (isUpdatingOwnDocument(userId) || isAdmin());
      allow delete: if isSignedIn() && (isOwner(userId) || isAdmin());
    }

    // --- /members/{memberId} ---
    match /members/{memberId} {
        function isOwner(memberId) { return request.auth.uid == memberId; }
        function isCreatingOwnProfile(memberId) { return request.auth.uid == memberId && request.resource.data.userId == request.auth.uid; }
        
        allow read: if isSignedIn(); // JEDER kann Profile lesen
        allow create: if isSignedIn() && isCreatingOwnProfile(memberId);
        allow update, delete: if isSignedIn() && (isOwner(memberId) || isAdmin());
    }

    // --- /groups/{groupId} ---
    match /groups/{groupId} {
        allow read: if isSignedIn(); // JEDER kann Gruppen lesen
        allow write: if isSignedIn() && isAdmin();

        // --- /groups/{groupId}/members/{memberId} ---
        match /members/{memberId} {
            allow read: if isSignedIn();
            allow write: if isSignedIn() && isAdmin();
        }
    }
    
    // --- /appointmentTypes/{typeId} ---
    match /appointmentTypes/{typeId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && isAdmin();
    }

    // --- /locations/{locationId} ---
    match /locations/{locationId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && isAdmin();
    }

    // --- /appointments/{appointmentId} ---
    match /appointments/{appointmentId} {
        allow read: if isSignedIn(); // JEDER kann Termine lesen
        allow write: if isSignedIn() && isAdmin();
    }
    
    // --- /appointmentResponses/{responseId} ---
    match /appointmentResponses/{responseId} {
        function isResponseOwner() { return request.resource.data.keys().hasAny(['userId']) && request.auth.uid == request.resource.data.userId; }
        function isExistingResponseOwner() { return resource != null && resource.data.keys().hasAny(['userId']) && request.auth.uid == resource.data.userId; }
        function isTeamMemberOfAppointment() {
            let app = get(/databases/$(database)/documents/appointments/$(resource.data.appointmentId));
            let member = get(/databases/$(database)/documents/members/$(request.auth.uid));
            return app.data.visibility.type == 'all' || (app.data.visibility.type == 'specificTeams' && member.data.teams.hasAny(app.data.visibility.teamIds));
        }

        allow get: if isSignedIn() && (isAdmin() || isExistingResponseOwner() || isTeamMemberOfAppointment());
        allow list: if isSignedIn();
        allow create: if isSignedIn() && isResponseOwner();
        allow update, delete: if isSignedIn() && (isExistingResponseOwner() || isAdmin());
    }

    // --- /appointmentExceptions/{exceptionId} ---
    match /appointmentExceptions/{exceptionId} {
        allow read: if isSignedIn(); // JEDER kann Ausnahmen lesen
        allow write: if isSignedIn() && isAdmin();
    }

    // --- /polls/{pollId} ---
    match /polls/{pollId} {
        allow read: if isSignedIn(); // JEDER kann Umfragen lesen
        allow create, delete: if isSignedIn() && isAdmin();
        allow update: if isSignedIn(); // Erlaube jedem das Abstimmen (Update am 'votes' Feld)
    }

    // --- /news/{newsId} ---
    match /news/{newsId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && isAdmin();
    }
    
    // --- /chats/{chatId} ---
    match /chats/{chatId} {
      function isChatMember() {
        return resource.data.userIds.hasAny([request.auth.uid]);
      }
      
      allow get, list: if isSignedIn() && (isAdmin() || isChatMember());
      allow write: if isSignedIn() && (isAdmin() || isChatMember());
      
      match /messages/{messageId} {
        function isMessageSender() {
          return request.resource.data.senderId == request.auth.uid;
        }
        
        allow get, list: if isSignedIn() && (isAdmin() || isChatMember());
        allow create: if isSignedIn() && isMessageSender();
        allow update, delete: if isSignedIn() && isAdmin();
      }
    }

    // --- /treasury/{transactionId} ---
    match /treasury/{transactionId} {
        allow read: if isSignedIn(); // JEDER kann Kasse lesen
        allow write: if isSignedIn() && isAdmin();
    }

    // --- /penalties/{penaltyId} ---
    match /penalties/{penaltyId} {
       allow read: if isSignedIn(); // JEDER kann Strafenkatalog lesen
       allow write: if isSignedIn() && isAdmin();
    }
  }
}
